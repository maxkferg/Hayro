# AGENTS.md

This document explains how to develop and validate changes in this repository.
Use it as the source of truth for local development expectations before opening a PR.

## Rust toolchain (must match CI)

CI uses `dtolnay/rust-toolchain@1.92.0`, so local development should use:

- Rust `1.92.0`
- `clippy` and `rustfmt` components
- `thumbv6m-none-eabi` target (for `no_std` checks)

## Development environment setup

From the repository root:

```bash
# Install the exact Rust version used by CI
rustup toolchain install 1.92.0

# Add required components and target for this toolchain
rustup component add --toolchain 1.92.0 clippy rustfmt
rustup target add --toolchain 1.92.0 thumbv6m-none-eabi

# Pin this repository to the CI toolchain
rustup override set 1.92.0

# Required for the CI feature-matrix check
cargo install cargo-hack
```

Verify:

```bash
rustc --version
cargo --version
cargo hack --version
```

## Required checks before opening a PR

Run all commands below from the repository root.
These mirror `.github/workflows/ci.yml`.

### 1) Linting, formatting, docs, and feature checks

```bash
RUSTFLAGS="-D warnings" cargo clippy --workspace --exclude hayro-demo --tests --examples
cargo fmt --check --all
RUSTFLAGS="-D warnings" cargo doc --workspace --exclude hayro-demo --no-deps
RUSTFLAGS="-D warnings" cargo hack check --each-feature --workspace --exclude hayro-demo
```

### 2) `no_std` compatibility checks

```bash
cargo check -p hayro-ccitt --target thumbv6m-none-eabi
cargo check -p hayro-font --no-default-features --target thumbv6m-none-eabi
cargo check -p hayro-jbig2 --no-default-features --target thumbv6m-none-eabi
cargo check -p hayro-jpeg2000 --no-default-features --target thumbv6m-none-eabi
cargo check -p hayro-syntax --no-default-features --target thumbv6m-none-eabi
```

### 3) CI test suite currently required for PRs

```bash
cargo test -p hayro-tests -- "load::"
```

## How to run tests locally

- Run the CI-required regression load tests:

  ```bash
  cargo test -p hayro-tests -- "load::"
  ```

- Run all tests in a specific crate:

  ```bash
  cargo test -p <crate-name>
  ```

- Run a specific test by name filter:

  ```bash
  cargo test -p hayro-tests -- "<test_name_or_filter>"
  ```

## hayro-demo frontend

### Architecture

The demo frontend lives in `hayro-demo/www/`. Key modules:

- `index.js` — Main application module (imports from the modules below)
- `viewer_math.js` — Pure coordinate-transform math (pdfToScreen, screenToPdf, clampZoom)
- `draw_helpers.js` — Canvas drawing preview helpers (ink/rect preview, color conversion, pointer mapping)
- `state_helpers.js` — Pure state computation (page layout, fit-zoom, toolbar state, history state, scroll tracking)
- `hayro_demo.js` / `hayro_demo_bg.wasm` — WASM bindings (generated by wasm-pack, gitignored)

### Building the WASM module

```bash
# Must use the 1.92.0 toolchain (edition2024 required)
RUSTUP_TOOLCHAIN=1.92.0 wasm-pack build hayro-demo --target web --out-dir www
```

**Note:** `wasm-pack` generates a blanket `*` gitignore in `www/`. The checked-in `www/.gitignore` overrides this to only ignore generated build artifacts. If you rebuild WASM, wasm-pack will overwrite `www/.gitignore` — restore it from git afterward (`git checkout hayro-demo/www/.gitignore`).

### Running the demo locally

```bash
python3 -m http.server 8080 --directory hayro-demo/www
# Then open http://localhost:8080
```

### Frontend unit tests

Pure-function JS unit tests use Node.js built-in `node:test` — no npm dependencies required:

```bash
node --test hayro-demo/tests-js/*.test.js
```

### Playwright E2E tests

End-to-end tests use Playwright with Chromium. One-time setup:

```bash
cd hayro-demo
npm install
npx playwright install --with-deps chromium
```

Run E2E tests:

```bash
cd hayro-demo
npx playwright test
```

The Playwright config (`hayro-demo/playwright.config.js`) auto-starts a static file server on port 8080 for the tests.

### Known Playwright gotcha: pointer events on overlapping positioned elements

Headless Chromium's `page.mouse` API does **not** reliably route pointer events to overlapping `position: absolute` elements (e.g., the annotation canvas layer that sits on top of the text layer and PDF canvas). Playwright dispatches the mouse event to whatever element the browser's hit-testing selects, which may not be the topmost visual layer in headless mode.

**Workaround:** Use `page.evaluate()` to dispatch `PointerEvent` objects directly on the target element. See `hayro-demo/e2e/annotation.spec.js` for the `drawOnAnnotationLayer()` and `drawInkOnAnnotationLayer()` helper functions as reference implementations.

### CSS and the HTML `hidden` attribute

When an element has an explicit CSS `display` value (e.g., `display: grid`), the HTML `hidden` attribute's implicit `display: none` is overridden and the element remains visible. Any element that uses both `hidden` toggling and an explicit `display` must have a corresponding `[hidden]` CSS rule:

```css
#my-element { display: grid; }
#my-element[hidden] { display: none; }
```

This pattern is already applied to `#empty-state` and `#drop-overlay` in `styles.css`.
